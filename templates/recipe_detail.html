{% extends "main.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ recipe.title }} - Recipe Details{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'recipe_detail.css' %}">
{% endblock %}

{% block content %}
<!-- Include the user-specific header -->
{% include 'user_header.html' %}

<div class="recipe-detail container">
    <!-- Select Recipe Button -->
    {% if swap_mode %}
    <div class="select-recipe">
        <a href="{% url 'dashboard_swap' recipe.id %}?meal_type={{ meal_type }}&day={{ day }}" 
           class="btn btn-primary">
            Select Recipe
        </a>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="back-button">
        <a href="{% if request.GET.from == 'dashboard' %}{% url 'dashboard' %}{% else %}
                {% url 'recipe_library' %}?swap={{ swap_mode|yesno:'1,' }}&meal_type={{ meal_type }}&day={{ day }}
                {% endif %}" 
        class="btn btn-secondary">
            ← {% if request.GET.from == 'dashboard' %}Back to Dashboard{% else %}Back to Recipe Library{% endif %}
        </a>
    </div>

    <!-- Recipe Header -->
    <header class="recipe-header">
        <h1>{{ recipe.title }}</h1>

        {% if child_age_months and recipe.min_age_months > child_age_months %}
        <p class="age-note" style="color: #c58f00; font-style: italic; margin-top: 6px;">
            This recipe is designed for little ones a bit older than {{ child_name }}.
        </p>
        {% endif %}

        {% if allergen_types %}
        <p style="background-color: #FCEAE4; color: #333; font-weight: 500; font-size: 0.9em; padding: 6px 10px; border-radius: 6px; margin-top: 6px;">
            Contains potential allergens: {{ allergen_types|join:", " }}
        </p>
        {% endif %}

        <p>{{ recipe.description }}</p>
    </header>

    <!-- Recipe Metadata Section -->
    <section class="recipe-metadata">
        <div class="metadata-card">
            <strong>Prep Time</strong>
            <p>{{ recipe.preparation_time }} min</p>
        </div>
        <div class="metadata-card">
            <strong>Cook Time</strong>
            <p>{{ recipe.cooking_time }} min</p>
        </div>
        <div class="metadata-card">
            <strong>Meal Type</strong>
            <p>
                {% for meal_type in recipe.meal_types.all %}
                    {{ meal_type.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
        </div>
        <div class="metadata-card">
            <strong>Age Suitability</strong>
            <p>{{ recipe.min_age_months }}–{{ recipe.max_age_months }} months</p>
        </div>
    </section>

    <!-- Ingredients Section (Clean Table) -->
    <section class="recipe-ingredients">
        <h2>Ingredients</h2>
        <table class="ingredients-table">
            <thead>
                <tr>
                    <th>Ingredient</th>
                    <th>Quantity</th>
                </tr>
            </thead>
            <tbody>
                {% for recipe_ingredient in recipe.recipeingredient_set.all %}
                <tr>
                    <td>{{ recipe_ingredient.ingredient.name }}</td>
                    <td>
                        {{ recipe_ingredient.quantity_as_fraction }}
                        {% if recipe_ingredient.unit %} {{ recipe_ingredient.unit }}{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>      

    <!-- Instructions Section -->
    <section class="recipe-instructions">
        <h2>Instructions</h2>
        <ol>
            {% for bold_text, normal_text in instructions|split_and_format %}
            <li>
                {% if bold_text %}<strong>{{ bold_text }}</strong>{% endif %} {{ normal_text }}
            </li>
            {% endfor %}
        </ol>
    </section>

    <!-- Tottable Tips (Subtle Light Box) -->
    <section class="recipe-tips">
        {% if recipe.tips %}
        <h2>Tottable Tips</h2>
        <ul>
            {% for bold_text, normal_text in recipe.tips|split_and_format %}
            <li>
                {% if bold_text %}<strong>{{ bold_text }}</strong>{% endif %} {{ normal_text }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </section>    
</div>

{% if show_age_modal %}
<div id="ageModal" class="modal show fade" tabindex="-1" style="display: block; background-color: rgba(0, 0, 0, 0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 12px;">
      <div class="modal-header">
        <h5 class="modal-title">Heads up!</h5>
        <button type="button" class="btn-close" onclick="document.getElementById('ageModal').style.display='none'"></button>
      </div>
      <div class="modal-body">
        <p>This recipe is designed for babies a bit older than {{ child_name }}. You can still use it later when they're ready!</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('ageModal').style.display='none'">Got it</button>
      </div>
    </div>
  </div>
</div>
{% endif %}


{% endblock %}
