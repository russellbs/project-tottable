{% extends 'main.html' %}
{% load static %}

{% block content %}
{% include 'user_header.html' %}

<div class="profile-container">
    <h1>My Profile</h1>

    <!-- User Details Section -->
    <div class="section user-details">
        <h2>Profile Details</h2>
        <p><strong>Name:</strong> {{ user.first_name }}</p>
        <p><strong>Email:</strong> {{ user.email }}</p>
        <p><strong>Member Since:</strong> {{ user.date_joined|date:"F j, Y" }}</p>
        <!-- Subscription Controls -->
        {% if trial_active %}
            <p><strong>Status:</strong> Free Trial</p>
            {% if trial_days_remaining is not None %}
                <p class="text-muted" style="font-size: 0.9em;">{{ trial_days_remaining }} day{{ trial_days_remaining|pluralize }} remaining</p>
            {% endif %}
            <a href="{% url 'upgrade_required' %}" class="btn btn-primary mt-2">Upgrade Now</a>
            <a href="{% url 'billing_portal' %}" class="btn btn-outline-secondary mt-2">Cancel Trial</a>
        {% elif user.is_subscribed %}
            <p><strong>Status:</strong> Active Subscription</p>
            <a href="{% url 'billing_portal' %}" class="btn btn-outline-secondary mt-2">Manage Your Subscription</a>
        {% else %}
            <p><strong>Status:</strong> Trial Ended</p>
            <a href="{% url 'upgrade_required' %}" class="btn btn-primary mt-2">Subscribe to Continue</a>
        {% endif %}
    </div>

    <!-- Meal Plan Preferences Section -->
    <div class="section meal-preferences">
        <h2>Meal Plan Preferences</h2>

        <!-- Meal Variety Preferences -->

        <!-- Meal Variety Display -->
        <div id="preferences-within-week-display">
            <h3>Meal Variety</h3>
            {% for pref in within_week_preferences_flat %}
                <p><strong>{{ pref.meal|capfirst }}:</strong> 
                    {% if pref.value == "no" %}
                        Same Meals ‚Äì Meals repeat throughout the week.
                    {% elif pref.value == "low" %}
                        Some Variety ‚Äì A few different meals with some repetition.
                    {% elif pref.value == "medium" %}
                        Balanced Variety ‚Äì A mix of different meals with minimal repetition.
                    {% elif pref.value == "high" %}
                        High Variety ‚Äì Every meal is different with no repeats.
                    {% else %}
                        {{ pref.value }}  <!-- Fallback if something unexpected appears -->
                    {% endif %}
                </p>
            {% endfor %}
            
            <h3 class="mt-4">Exclude Purees?</h3>
            <p><strong>Exclude Purees:</strong> 
                {% if user.profile.exclude_purees %}Yes{% else %}No{% endif %}
            </p>
            <button id="edit-within-week-preferences-btn" class="btn btn-primary">Edit Meal Plan Preferences</button>
        </div>

        <form id="preferences-within-week-form" method="POST" action="{% url 'update_within_week_preferences' %}" style="display: none;">
            {% csrf_token %}
            <h3>Update Meal Variety</h3>
            {% for pref in within_week_preferences_flat %}
            <div class="form-group">
                <label for="within_week_{{ pref.meal|slugify }}">{{ pref.meal|capfirst }}</label>
                <select name="{{ pref.meal }}" id="within_week_{{ pref.meal|slugify }}" class="form-control">
                    <option value="no" {% if pref.value == "No Variety" %}selected{% endif %}>
                        Same Meals ‚Äì Meals repeat throughout the week.
                    </option>
                    <option value="low" {% if pref.value == "Low Variety" %}selected{% endif %}>
                        Some Variety ‚Äì A few different meals with some repetition.
                    </option>
                    <option value="medium" {% if pref.value == "Medium Variety" %}selected{% endif %}>
                        Balanced Variety ‚Äì A mix of different meals with minimal repetition.
                    </option>
                    <option value="high" {% if pref.value == "High Variety" %}selected{% endif %}>
                        High Variety ‚Äì Every meal is different with no repeats.
                    </option>
                </select>                
            </div>
            {% endfor %}

            <h3 class="mt-4">Exclude Purees?</h3>
            <div class="form-check mt-3">
                <input type="hidden" name="exclude_purees" value="off">
                <input class="form-check-input" type="checkbox" name="exclude_purees" id="exclude-purees-checkbox"
                    value="on"
                    {% if user.profile.exclude_purees %}checked{% endif %}>
                <label class="form-check-label" for="exclude-purees-checkbox">
                    <strong>Exclude Purees</strong> ‚Äì Hide puree-style recipes from your meal plans if your little one has moved on to solids.
                </label>
            </div>

            <button type="submit" class="btn btn-success">Save Meal Preferences</button>
            <button type="button" id="cancel-within-week-preferences-btn" class="btn btn-secondary">Cancel</button>
        </form>
        
        <!-- Regenerate Meal Plan Button for Each Child -->
        {% for child in children %}
        <div id="regenerate-meal-plan-section-{{ child.id }}" style="margin-top: 20px;">
            <button id="regenerate-meal-plan-btn-{{ child.id }}" class="btn btn-warning regenerate-meal-plan-btn" data-child-id="{{ child.id }}">
                Regenerate {{ child.name }}'s Meal Plan
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Little Munchkins Section -->
    <div class="section children-section">
        <h2>Little Munchkins</h2>

        <!-- Display existing children -->
        <div id="children-list">
            {% for child in children %}
            <div class="child-profile" id="child-{{ child.id }}">
                <div class="child-display">
                    <h3>{{ child.name }}</h3>
                    <p><strong>Date of Birth:</strong> {{ child.dob }}</p>
                    <p><strong>Age:</strong> {{ child.age_display }}</p>
                    <p><strong>Likes Ingredients:</strong> {{ child.likes_ingredients.all|join:", " }}</p>
                    <p><strong>Dislikes Ingredients:</strong> {{ child.dislikes_ingredients.all|join:", " }}</p>
                    <p><strong>Allergies:</strong> {{ child.allergies|default:"None" }}</p>

                    <!-- Edit Button -->
                    <button class="btn btn-secondary edit-child-btn" data-child-id="{{ child.id }}">Edit</button>
                </div>

                <!-- Edit Form (Hidden by Default) -->
                <div class="child-edit-form" style="display: none;">
                    <form class="edit-child-form" method="POST" action="{% url 'edit_child' %}" data-child-id="{{ child.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="child_id" value="{{ child.id }}">

                        <div class="form-group">
                            <label for="name-{{ child.id }}">Munchkin's Name</label>
                            <input type="text" name="name" id="name-{{ child.id }}" class="form-control" value="{{ child.name }}" required>
                        </div>

                        <div class="form-group">
                            <label for="dob-{{ child.id }}">Date of Birth</label>
                            <input type="date" name="dob" id="dob-{{ child.id }}" class="form-control" value="{{ child.dob|date:'Y-m-d' }}" required>
                        </div>

                        <div class="form-group">
                            <label for="likes-ingredients-{{ child.id }}">Likes Ingredients</label>
                            <input type="text" class="ingredient-search" placeholder="Search ingredients..." data-target="likes-ingredients-{{ child.id }}">
                            <div class="custom-multi-select" id="likes-ingredients-{{ child.id }}">
                                {% for ingredient in ingredients %}
                                <div class="ingredient-option">
                                    <input type="checkbox" id="likes-{{ child.id }}-{{ ingredient.id }}" name="likes_ingredients" value="{{ ingredient.id }}" 
                                           {% if ingredient in child.likes_ingredients.all %}checked{% endif %}>
                                    <label for="likes-{{ child.id }}-{{ ingredient.id }}">{{ ingredient.name }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="dislikes-ingredients-{{ child.id }}">Dislikes Ingredients</label>
                            <input type="text" class="ingredient-search" placeholder="Search ingredients..." data-target="dislikes-ingredients-{{ child.id }}">
                            <div class="custom-multi-select" id="dislikes-ingredients-{{ child.id }}">
                                {% for ingredient in ingredients %}
                                <div class="ingredient-option">
                                    <input type="checkbox" id="dislikes-{{ child.id }}-{{ ingredient.id }}" name="dislikes_ingredients" value="{{ ingredient.id }}" 
                                           {% if ingredient in child.dislikes_ingredients.all %}checked{% endif %}>
                                    <label for="dislikes-{{ child.id }}-{{ ingredient.id }}">{{ ingredient.name }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>                        

                        <div class="form-group">
                            <label for="allergies-{{ child.id }}">Allergies</label>
                            <input type="text" class="ingredient-search" placeholder="Search allergies..." data-target="allergies-{{ child.id }}">
                            <div class="custom-multi-select" id="allergies-{{ child.id }}">
                                {% for allergen in allergens %}
                                <div class="ingredient-option">
                                    <input type="checkbox" id="allergies-{{ child.id }}-{{ allergen }}" name="allergies" value="{{ allergen }}"
                                           {% if allergen in child.allergies %}checked{% endif %}>
                                    <label for="allergies-{{ child.id }}-{{ allergen }}">{{ allergen }}</label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>                        

                        <button type="submit" class="btn btn-success save-child-btn">Save Changes</button>
                        <button type="button" class="btn btn-danger delete-child-btn" data-child-id="{{ child.id }}">Delete</button>
                        <button type="button" class="btn btn-secondary cancel-edit-btn" data-child-id="{{ child.id }}">Cancel</button>
                    </form>
                </div>
            </div>
            {% empty %}
            <p>No Little Munchkins added yet.</p>
            {% endfor %}
        </div>

        <!-- Add Child Button -->
        <button id="add-child-btn" class="btn btn-primary">Add Little Munchkin</button>
    </div>

    <!-- Add Child Form -->
    <div id="add-child-form" style="display: none;">
        <form id="add-child-form-element" method="POST" action="{% url 'add_child' %}">
            {% csrf_token %}

            <div class="form-group">
                <label for="name">Munchkin's Name</label>
                <input type="text" name="name" id="name" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="dob">Date of Birth</label>
                <input type="date" name="dob" id="dob" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="likes_ingredients">Likes Ingredients</label>
                <input type="text" class="ingredient-search" placeholder="Search ingredients..." data-target="likes-ingredients">
                <div class="custom-multi-select" id="likes-ingredients">
                    {% for ingredient in ingredients %}
                    <div class="ingredient-option">
                        <input type="checkbox" id="likes-{{ ingredient.id }}" name="likes_ingredients" value="{{ ingredient.id }}">
                        <label for="likes-{{ ingredient.id }}">{{ ingredient.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="dislikes_ingredients">Dislikes Ingredients</label>
                <input type="text" class="ingredient-search" placeholder="Search ingredients..." data-target="dislikes-ingredients">
                <div class="custom-multi-select" id="dislikes-ingredients">
                    {% for ingredient in ingredients %}
                    <div class="ingredient-option">
                        <input type="checkbox" id="dislikes-{{ ingredient.id }}" name="dislikes_ingredients" value="{{ ingredient.id }}">
                        <label for="dislikes-{{ ingredient.id }}">{{ ingredient.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="allergies">Allergies</label>
                <input type="text" class="ingredient-search" placeholder="Search allergies..." data-target="allergies">
                <div class="custom-multi-select" id="allergies">
                    {% for allergen in allergens %}
                    <div class="ingredient-option">
                        <input type="checkbox" id="allergies-{{ allergen }}" name="allergies" value="{{ allergen }}">
                        <label for="allergies-{{ allergen }}">{{ allergen }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>                              

            <button type="submit" class="btn btn-primary">Save Munchkin</button>
            <button type="button" id="cancel-add-child-btn" class="btn btn-secondary">Cancel</button>
        </form>
    </div>
</div>

<link rel="stylesheet" href="{% static 'profile.css' %}">
<script src="{% static 'profile.js' %}"></script>
<script src="{% static 'profile_preferences.js' %}"></script>

{% if show_welcome %}
<!-- Welcome Modal -->
<div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="welcomeModalLabel">Welcome to Tottable! üéâ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Welcome to Tottable! üéâ We're so excited to help lighten your mental load.</p>
        <p>Here‚Äôs how to get started:</p>
        <p>üë∂ <strong>Add your little one‚Äôs name and birthday</strong> so we can recommend the right meals for their age.</p>
        <p>üçΩÔ∏è <strong>Tell us what foods they love, dislike, or need to avoid</strong> ‚Äî we‚Äôll keep it all in mind.</p>
        <p>üîÑ <strong>Choose your meal variety</strong> ‚Äî pick how much you want things to change from day to day.</p>
        <p class="mt-3">That‚Äôs it! üéà We‚Äôll take it from there and create a personalized meal plan you can tweak anytime.</p>
    
        <hr>
        <p class="text-muted" style="font-size: 0.9em;">
          Every baby is unique. Tottable offers meal suggestions to inspire you, but we always recommend checking with your healthcare professional before introducing new foods ‚Äî and using your own judgment to make sure meals are right for your little one.
        </p>
    </div>      
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Let's Go!</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if request.session.pixel_conversion_event == "subscribe" %}
<script>
  ttq.track('Subscribe');
</script>
{% endif %}

{% endblock %}


